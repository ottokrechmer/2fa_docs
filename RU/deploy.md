# Развертка решения

## Общая схема работы

Приложение работает следующим образом:

- На сервер `OpenVPN` приходит запрос от пользователя на авторизацию. Пользователь указывает:
  - Логин
  - Пароль
  - ОТП (опционально)
- Сервер `OpenVPN` через `auth-pam-plugin` вызывает PAM-модуль `simple2fa_pam.so` для авторизации
- PAM-модуль отправляет запрос на сервер `simple2fa` где, в зависимости от вида второго фактора
  - Валидируется ОТП
  - Отправляется запрос на подтверждение в Telegram
- После успешной валидации или подтверждения логина в Telegram запрос возвращает статус и пользователь авторизуется в `OpenVPN`

## Установка

### Установка OpenVPN

Установить и настроить OpenVPN можно по инструкциям в Интернете
> Важно!
>
> Требуется установить версию OpenVPN 2.6+, так как она поддерживает передачу IP адреса подключающегося пользователя. Сделать это можно по [инструкции](https://community.openvpn.net/openvpn/wiki/OpenvpnSoftwareRepos)

### Установка PAM-модуля

Для установки PAM-модуля `simple2fa_pam.so` необходимо просто положить его в директорию с другими PAM-модулями.\
Они располагаются в папке `security`. Найти ее можно по команде

```bash
find /lib* /usr/lib* -type d -name security
```

Обычно это одно из двух расположений:

```bash
/usr/lib/x86_64-linux-gnu/security/
/usr/lib64/security/
```

### Подключение PAM-модуля

Для подключения модуля необходимо:
***

Найти, файл `server.conf` OpenVPN. Обычно он располагается в `/etc/openvpn/server/`\
В файле необходимо добавить (или заменить) следующие строки:

```conf
script-security 2
plugin /usr/lib64/openvpn/plugins/openvpn-plugin-auth-pam.so "openvpn username USERNAME password PASSWORD otp OTP"
setenv deferred_auth_pam 1
```

- `script-security 2` отвечает за то, что в плагин будут передаваться данные о пользователе
- `plugin...` указывает, что необходимо для авторизации подключить встроенный плагин `openvpn-plugin-auth-pam` и настроить его
  - `openvpn` - использовать конфиг с именем `openvpn` (см ниже). Имя вы можете выбрать любое на ваш вкус
  - `username USERNAME password PASSWORD otp OTP` - передать в PAM-модуль данные о логине, пароле и ОТП пользователя
  > NB
  >
  > Даже если вы не планируете использовать ОТП, рекомендуем указать настройку так. Чтобы если вы потом захотите его использовать, не пришлось вспоминать, что настройки нет
- `setenv deferred_auth_pam 1` отвечает за то, что все процессы авторизации будут происходить асинхронно, так как в противном случае ожидание ответа от PAM-модуля заблокирует весь процесс работы сервера OpenVPN

***
Создать файл настроек `s2fa_conf.toml` в той же папке, что и `server.conf`\
Пример и описание настроек `s2fa_conf.toml` см в [соответствующем разделе](toml.md)

***

Создать файл `openvpn` (мы указали его в предыдущем пункте, как файл для чтения плагином) в папке `/etc/pam.d/` и заполнить его:

```conf
auth    requisite   simple2fa_pam.so
account sufficient  pam_permit.so
session sufficient  pam_permit.so
```

Здесь мы указываем PAM-модуль, который будет обрабатывать запрос и устанавливаем разрешение на аккаунтинг и сессии

***

Перезапустить OpenVPN сервер

```bash
sudo systemctl restart openvpn-server@server
```

***

В конфиге клиента указать

```conf
auth-user-pass
```

и в случае использования ОТП (тогда клиент запросит ОТП помимо логина и пароля)

```conf
static-challenge "Enter OTP" 0
```
